generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  admin
  member
}

enum TaskStatus {
  todo
  in_progress
  review
  done
}

enum TaskPriority {
  low
  medium
  high
}

enum TaskActionType {
  status_changed
  reassigned
  edited
}

model User {
  id           Int            @id @default(autoincrement())
  name         String
  email        String         @unique
  passwordHash String         @map("password_hash")
  role         UserRole
  createdAt    DateTime       @default(now()) @map("created_at")

  projects     Project[]
  tasks        Task[]         @relation("TaskAssignedTo")
  activities   TaskActivity[] @relation("ActivityChangedBy")

  @@map("users")
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String
  createdBy   Int      @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  creator     User     @relation(fields: [createdBy], references: [id], onDelete: Restrict)
  tasks       Task[]

  @@map("projects")
}

model Task {
  id          Int            @id @default(autoincrement())
  title       String
  description String
  status      TaskStatus
  priority    TaskPriority
  dueDate     DateTime?      @map("due_date")
  projectId   Int            @map("project_id")
  assignedTo  Int            @map("assigned_to")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  project     Project        @relation(fields: [projectId], references: [id], onDelete: Restrict)
  assignee    User           @relation("TaskAssignedTo", fields: [assignedTo], references: [id], onDelete: Restrict)
  activities  TaskActivity[]

  @@index([status])
  @@index([assignedTo])
  @@index([dueDate])
  @@index([projectId])
  @@map("tasks")
}

model TaskActivity {
  id         Int            @id @default(autoincrement())
  taskId      Int           @map("task_id")
  actionType  TaskActionType @map("action_type")
  oldValue    String?       @map("old_value")
  newValue    String?       @map("new_value")
  changedBy   Int           @map("changed_by")
  timestamp   DateTime      @default(now())

  task        Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  changedByUser User        @relation("ActivityChangedBy", fields: [changedBy], references: [id], onDelete: Restrict)

  @@index([taskId])
  @@map("task_activities")
}